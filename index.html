<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ALTHEA NEXUS">
    
    <link rel="apple-touch-icon" href="nexus-icon.png">
    
    <title>ALTHEA NEXUS | V25.6</title>
    <style>
        :root { --neon-green: #0f0; --dark-bg: #000; --panel-bg: #0a0a0a; --ui-cyan: #0ff; }
        body { background: var(--dark-bg); color: var(--neon-green); font-family: 'Courier New', monospace; margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; overflow: hidden; }
        
        .terminal { background: #050505; border: 1px solid #333; height: 100px; overflow-y: auto; padding: 8px; font-size: 11px; margin-bottom: 8px; }
        .status-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 10px; }
        #statusLight { width: 10px; height: 10px; border-radius: 50%; background: #300; transition: 0.3s; }

        /* GRID SYSTEM */
        .portal-grid { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; min-height: 0; }
        @media (min-width: 601px) { .portal-grid { flex-direction: row; } }

        .panel { 
            display: flex; flex-direction: column; border: 1px solid #222; 
            background: var(--panel-bg); position: relative; flex: 1;
            order: 0; transition: order 0.3s ease; overflow: hidden;
        }
        
        /* THE CRITICAL FULLSCREEN FIX */
        .panel.fullscreen { 
            position: fixed !important; 
            inset: 0 !important; 
            z-index: 10000 !important; 
            width: 100vw !important; 
            height: 100vh !important; 
            margin: 0 !important; 
            order: unset !important; 
            border: none;
        }

        .panel-header { padding: 6px; font-size: 10px; background: #111; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .panel-header button { background: transparent; color: var(--neon-green); border: 1px solid var(--neon-green); font-size: 9px; padding: 2px 5px; cursor: pointer; }

        textarea { flex-grow: 1; background: transparent; color: var(--neon-green); border: none; padding: 10px; resize: none; font-size: 11px; outline: none; width: 100%; height: 100%; }
        iframe { flex-grow: 1; background: #fff; border: none; width: 100%; height: 100%; }
        
        #vesselHistory { height: 50px; background: #050505; border: 1px solid #222; overflow-y: auto; font-size: 10px; color: #666; padding: 5px; margin-top: 5px; }

        .controls { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-top: 8px; }
        .btn { background: #111; color: var(--neon-green); border: 1px solid var(--neon-green); padding: 8px 2px; cursor: pointer; font-size: 9px; font-weight: bold; text-align: center; }
        
        #fileInputLabel { background: #111; color: var(--ui-cyan); border: 1px dashed var(--ui-cyan); text-align: center; padding: 10px; cursor: pointer; font-size: 11px; margin-bottom: 8px; }

        @media (max-width: 600px) {
            .controls { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="status-row">
        <div id="statusLight"></div>
        <span id="statusText">ALTHEA V25.6: ACTIVE</span>
    </div>

    <div class="terminal" id="term"><div>[NEXUS STABILIZED]</div></div>

    <label id="fileInputLabel">
        [+] SCAN LOCAL VESSEL
        <input type="file" id="fileInput" style="display:none" onchange="loadVessel(this)">
    </label>

    <div class="portal-grid" id="masterGrid">
        <div class="panel" id="inspectorPanel">
            <div class="panel-header">
                <span>CODE INSPECTOR</span>
                <div><span id="fileName" style="color:#555">---</span><button onclick="toggleFullscreen(this)">FULL</button></div>
            </div>
            <textarea id="codeEditor" spellcheck="false" placeholder="Awaiting code..."></textarea>
        </div>
        <div class="panel" id="portalPanel">
            <div class="panel-header">
                <span>PORTAL VIEW</span>
                <div><span id="fpsCounter" style="color:#555">WAITING</span><button onclick="toggleFullscreen(this)">FULL</button></div>
            </div>
            <iframe id="vesselFrame" sandbox="allow-scripts allow-forms allow-modals allow-same-origin"></iframe>
        </div>
    </div>

    <div id="vesselHistory"><div>* SESSION READY *</div></div>

    <div class="controls">
        <div class="btn" onclick="applyChanges()">APPLY</div>
        <div class="btn" onclick="saveFile()">SAVE</div>
        <div class="btn" onclick="swapPanels()">SWAP</div>
        <div class="btn" onclick="requestSnapshot()" style="color:orange; border-color:orange;">SNAP</div>
        <div class="btn" onclick="clearSession()" style="color:#f00; border-color:#f00;">PURGE</div>
    </div>

    <script>
        const log = (m, c="#0f0") => { 
            const d = document.getElementById('term'); 
            d.innerHTML += `<div>> <span style="color:${c}">${m}</span></div>`; 
            d.scrollTop = d.scrollHeight; 
        };

        let isSwapped = false;

        window.addEventListener('message', (e) => {
            if (e.data.type === 'vessel_log') {
                log(`[VESSEL]: ${e.data.msg}`, "#0ff");
                if(e.data.msg.includes("fps")) document.getElementById('fpsCounter').innerText = e.data.msg;
            }
        });

        function loadVessel(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('codeEditor').value = e.target.result;
                document.getElementById('fileName').innerText = file.name;
                applyChanges();
                addToHistory(file.name, "LOADED");
            };
            reader.readAsText(file);
        }

        function applyChanges() {
            const content = document.getElementById('codeEditor').value;
            const blob = new Blob([content], { type: 'text/html' });
            const frame = document.getElementById('vesselFrame');
            if(frame.src.startsWith('blob:')) URL.revokeObjectURL(frame.src);
            frame.src = URL.createObjectURL(blob);
            document.getElementById('statusLight').style.background = 'var(--neon-green)';
            document.getElementById('statusText').innerText = "ONLINE: IMITATION ACTIVE";
            log("Injection complete.");
        }

        function toggleFullscreen(btn) {
            const panel = btn.closest('.panel');
            
            // Auto-close any other full-screen panel
            document.querySelectorAll('.panel.fullscreen').forEach(p => {
                if (p !== panel) {
                    p.classList.remove('fullscreen');
                    p.querySelector('.panel-header button').innerText = 'FULL';
                }
            });

            const isFull = panel.classList.toggle('fullscreen');
            btn.innerText = isFull ? 'EXIT' : 'FULL';
            log(`UI: ${panel.id} is now ${isFull ? 'FULLSCREEN' : 'GRID'}`);
        }

        function swapPanels() {
            isSwapped = !isSwapped;
            document.getElementById('inspectorPanel').style.order = isSwapped ? "2" : "1";
            document.getElementById('portalPanel').style.order = isSwapped ? "1" : "2";
            log(`UI: Position SWAP ${isSwapped ? 'ON' : 'OFF'}`);
        }

        function addToHistory(name, status) {
            const h = document.getElementById('vesselHistory');
            if (h.innerText.includes("SESSION READY")) h.innerHTML = "";
            const entry = document.createElement('div');
            entry.innerHTML = `<span style="color:#444">[${new Date().toLocaleTimeString()}]</span> ${name} : ${status}`;
            h.insertBefore(entry, h.firstChild);
        }

        function requestSnapshot() {
            log("Capturing frame...");
            document.getElementById('vesselFrame').contentWindow.postMessage({ type: 'SNAPSHOT_REQUEST' }, '*');
        }

        function saveFile() {
            const content = document.getElementById('codeEditor').value;
            const blob = new Blob([content], { type: 'text/html' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "NEXUS_" + document.getElementById('fileName').innerText;
            link.click();
            addToHistory(document.getElementById('fileName').innerText, "SAVED");
        }

        function clearSession() {
            if (confirm("PURGE SESSION?")) location.reload();
        }
    </script>
</body>
</html>
