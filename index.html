<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ALTHEA NEXUS | V26.1 SOVEREIGN</title>
    <style>
        :root { --neon-green: #0f0; --dark-bg: #000; --panel-bg: #0a0a0a; --ui-cyan: #0ff; --bully-magenta: #f0f; --warn-orange: #ffa500; }
        body { background: var(--dark-bg); color: var(--neon-green); font-family: 'Courier New', monospace; margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; overflow: hidden; }
        .terminal { background: #050505; border: 1px solid #333; height: 120px; overflow-y: auto; padding: 8px; font-size: 10px; margin-bottom: 8px; border-left: 3px solid var(--neon-green); box-shadow: inset 0 0 10px #000; }
        .cli-row { display: flex; gap: 5px; margin-bottom: 8px; background: #111; padding: 5px; border: 1px solid #222; font-size: 10px; }
        #cliInput { flex-grow: 1; background: transparent; border: none; color: #fff; font-family: monospace; outline: none; }
        .portal-grid { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; min-height: 0; }
        @media (min-width: 601px) { .portal-grid { flex-direction: row; } }
        .panel { display: flex; flex-direction: column; border: 1px solid #222; background: var(--panel-bg); flex: 1; overflow: hidden; }
        .panel-header { padding: 6px; font-size: 10px; background: #111; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        textarea { flex-grow: 1; background: transparent; color: var(--neon-green); border: none; padding: 10px; resize: none; font-size: 11px; outline: none; font-family: 'Courier New', monospace; line-height: 1.4; }
        iframe { flex-grow: 1; background: #fff; border: none; }
        .controls { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-top: 8px; }
        .btn { background: #111; color: var(--neon-green); border: 1px solid var(--neon-green); padding: 10px 2px; cursor: pointer; font-size: 8px; font-weight: bold; text-align: center; text-transform: uppercase; }
        .btn:active { background: var(--neon-green); color: #000; }
    </style>
</head>
<body>
    <div class="terminal" id="term"><div>[SYSTEM_READY] V26.1 Sovereign Core Active.</div></div>

    <div class="cli-row">
        <span style="color:var(--ui-cyan)">root@nexus:~#</span>
        <input type="text" id="cliInput" placeholder="install [repo] | df | clear" onkeydown="if(event.key==='Enter') runCommand(this.value)">
    </div>

    <div class="portal-grid">
        <div class="panel">
            <div class="panel-header"><span>SYSTEM_INSPECTOR</span><span id="fileName" style="color:#555">app.py [LOCAL]</span></div>
            <textarea id="codeEditor" spellcheck="false" placeholder="Waiting for code..."></textarea>
        </div>
        <div class="panel">
            <div class="panel-header">
                <span>PORTAL_VIEW</span>
                <select id="modeSelect" onchange="applyChanges()" style="background:#000; color:var(--neon-green); border:1px solid #333; font-size:9px;">
                    <option value="html">STATIC_HTML_MODE</option>
                    <option value="flask">FLASK_SERVER_MODE</option>
                </select>
            </div>
            <iframe id="vesselFrame" sandbox="allow-scripts allow-forms allow-modals"></iframe>
        </div>
    </div>

    <div class="controls">
        <div class="btn" onclick="deepInstall()" style="color:var(--ui-cyan)">DEEP_INSTALL</div>
        <div class="btn" onclick="seedProject()" style="color:var(--bully-magenta)">SEED_STRESS</div>
        <div class="btn" onclick="applyChanges()">HOT_RELOAD</div>
        <div class="btn" onclick="exportLinuxMirror()" style="color:var(--warn-orange)">EXPORT_TXT</div>
        <div class="btn" onclick="document.getElementById('recInput').click()" style="color:#fff">RECOVERY</div>
        <div class="btn" onclick="clearSession()" style="color:red">PURGE</div>
    </div>
    <input type="file" id="recInput" style="display:none" onchange="importLinuxMirror(this)">

    <script>
        const DB_NAME = "NexusFS", STORE_NAME = "files";
        const log = (m, c="#0f0") => { 
            const d = document.getElementById('term'); 
            d.innerHTML += `<div><span style="color:#444">[${new Date().toLocaleTimeString()}]</span> > <span style="color:${c}">${m}</span></div>`; 
            d.scrollTop = d.scrollHeight; 
        };

        const openDB = () => new Promise(res => { 
            const r = indexedDB.open(DB_NAME, 1); 
            r.onupgradeneeded = e => e.target.result.createObjectStore(STORE_NAME); 
            r.onsuccess = e => res(e.target.result); 
        });

        async function runCommand(val) {
            const [cmd, path] = val.split(' ');
            if (cmd === 'install' && path) {
                log(`FETCHING: ${path}...`, "yellow");
                // Virtual Pip simulation
                const db = await openDB();
                const tx = db.transaction(STORE_NAME, "readwrite");
                await tx.objectStore(STORE_NAME).put(`# Module ${path}`, `/lib/python3.11/site-packages/${path}/__init__.py`);
                log(`INSTALLED: ${path}`, "#0f0");
            } else if (cmd === 'df' || cmd === 'status') {
                const db = await openDB();
                const keys = await new Promise(res => db.transaction(STORE_NAME).objectStore(STORE_NAME).getAllKeys().onsuccess = e => res(e.target.result));
                log(`DISK_USAGE: ${keys.length} blocks mapped.`, "var(--ui-cyan)");
            } else if (cmd === 'clear') { document.getElementById('term').innerHTML = ''; }
            document.getElementById('cliInput').value = '';
        }

        async function deepInstall() {
            log("INITIATING DEEP-STACK...", "var(--ui-cyan)");
            const libs = ['flask', 'werkzeug', 'jinja2', 'click', 'itsdangerous', 'markupsafe'];
            const db = await openDB();
            for (const lib of libs) {
                const tx = db.transaction(STORE_NAME, "readwrite");
                await tx.objectStore(STORE_NAME).put(`# ${lib} virtualized`, `/lib/python3.11/site-packages/${lib}/__init__.py`);
                log(`PROVISIONED: ${lib}`, "yellow");
            }
            log("LINUX MIRROR READY.", "#0f0");
        }

        async function seedProject() {
            const stressCode = `<!DOCTYPE html><body style="background:#000;overflow:hidden;"><script>for(let i=0;i<50;i++){const r=document.createElement('div');r.style="position:absolute;border:2px solid #0f0;border-radius:50%;width:"+(50+i*5)+"px;height:"+(50+i*5)+"px;left:calc(50% - "+(25+i*2.5)+"px);top:calc(50% - "+(25+i*2.5)+"px);box-shadow:0 0 10px #0f0;animation:p 2s infinite "+(i*0.1)+"s";document.body.appendChild(r);}document.write('<style>@keyframes p{0%,100%{opacity:0.3;transform:scale(1)}50%{opacity:1;transform:scale(1.1)}}</style><div style="color:#0f0;font-family:monospace;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#000;padding:10px;border:1px solid #0f0;">FLASK ENGINE: 50 RINGS ACTIVE</div>')<\/script></body>`;
            document.getElementById('codeEditor').value = stressCode;
            const db = await openDB();
            await db.transaction(STORE_NAME, "readwrite").objectStore(STORE_NAME).put(stressCode, "app.py");
            log("SEEDING: app.py written to Virtual Drive.", "var(--bully-magenta)");
            applyChanges();
        }

        function applyChanges() {
            const mode = document.getElementById('modeSelect').value;
            const content = document.getElementById('codeEditor').value;
            const frame = document.getElementById('vesselFrame');
            log(`MODE: ${mode.toUpperCase()} RELOAD`, "#fff");
            
            const blob = new Blob([content], { type: 'text/html' });
            if(frame.src.startsWith('blob:')) URL.revokeObjectURL(frame.src);
            frame.src = URL.createObjectURL(blob);
        }

        async function exportLinuxMirror() {
            log("PACKAGING SYSTEM IMAGE...", "var(--warn-orange)");
            const db = await openDB();
            const store = db.transaction(STORE_NAME, "readonly").objectStore(STORE_NAME);
            const keys = await new Promise(res => store.getAllKeys().onsuccess = e => res(e.target.result));
            const vals = await new Promise(res => store.getAll().onsuccess = e => res(e.target.result));
            const data = { version: "26.1", files: {} };
            keys.forEach((k, i) => data.files[k] = vals[i]);
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], {type:'text/plain'}));
            link.download = "NEXUS_SYSTEM_IMAGE.txt";
            link.click();
            log("EXPORT COMPLETE.", "#0f0");
        }

        async function importLinuxMirror(input) {
            log("HARD BOOT INITIATED...", "var(--bully-magenta)");
            try {
                const text = await input.files[0].text();
                const driveData = JSON.parse(text);
                const db = await openDB();
                const tx = db.transaction(STORE_NAME, "readwrite");
                const store = tx.objectStore(STORE_NAME);
                await store.clear(); 
                for (const [p, c] of Object.entries(driveData.files)) await store.put(c, p);
                log(`BOOT SUCCESS: ${Object.keys(driveData.files).length} files re-linked.`, "#0f0");
                if(driveData.files["app.py"]) {
                    document.getElementById('codeEditor').value = driveData.files["app.py"];
                    applyChanges();
                }
            } catch (err) { log("BOOT FAILED: Corrupt image.", "red"); }
        }

        function clearSession() { if(confirm("PURGE VIRTUAL DRIVE?")) location.reload(); }
    </script>
</body>
</html>
