<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ALTHEA NEXUS | V26.6 RECOVERY_FIX</title>
    <style>
        :root { --neon-green: #0f0; --dark-bg: #000; --panel-bg: #0a0a0a; --ui-cyan: #0ff; --bully-magenta: #f0f; }
        body { background: var(--dark-bg); color: var(--neon-green); font-family: 'Courier New', monospace; margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; overflow: hidden; }
        .terminal { background: #050505; border: 1px solid #333; height: 80px; overflow-y: auto; padding: 8px; font-size: 10px; margin-bottom: 8px; border-left: 3px solid var(--neon-green); }
        #fileInputLabel { background: #111; color: var(--ui-cyan); border: 1px dashed var(--ui-cyan); text-align: center; padding: 10px; cursor: pointer; font-size: 10px; margin-bottom: 8px; display: block; }
        .cli-row { display: flex; gap: 5px; margin-bottom: 8px; background: #111; padding: 5px; border: 1px solid #222; font-size: 10px; }
        #cliInput { flex-grow: 1; background: transparent; border: none; color: #fff; font-family: monospace; outline: none; }
        .portal-grid { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; min-height: 0; position: relative; }
        @media (min-width: 601px) { .portal-grid { flex-direction: row; } }
        .panel { display: flex; flex-direction: column; border: 1px solid #222; background: var(--panel-bg); flex: 1; overflow: hidden; }
        .panel.fullscreen { position: fixed !important; inset: 0 !important; z-index: 10000; width: 100vw; height: 100vh; margin: 0; }
        .panel-header { padding: 6px; font-size: 10px; background: #111; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        textarea { flex-grow: 1; background: transparent; color: var(--neon-green); border: none; padding: 10px; resize: none; font-size: 11px; outline: none; font-family: 'Courier New', monospace; }
        iframe { flex-grow: 1; background: #fff; border: none; }
        .controls { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-top: 8px; }
        .btn { background: #111; color: var(--neon-green); border: 1px solid var(--neon-green); padding: 10px 2px; cursor: pointer; font-size: 8px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>
    <div class="terminal" id="term"><div>[EMULATION_ENGINE_V26.6] Ready for Boot.</div></div>

    <label id="fileInputLabel">
        [M] MOUNT & EMULATE FOLDER
        <input type="file" id="folderPicker" webkitdirectory directory multiple style="display:none" onchange="mountAndIngest(this)">
    </label>

    <div class="cli-row">
        <span style="color:var(--ui-cyan)">root@nexus:~#</span>
        <input type="text" id="cliInput" placeholder="ls | open [file]" onkeydown="if(event.key==='Enter') runCommand(this.value)">
    </div>

    <div class="portal-grid">
        <div class="panel" id="p1">
            <div class="panel-header"><span>INSPECTOR: <span id="curFile" style="color:#555">none</span></span><button onclick="toggleFS('p1')" style="background:none;color:var(--neon-green);border:1px solid">MAX</button></div>
            <textarea id="codeEditor" spellcheck="false" oninput="autoSave()"></textarea>
        </div>
        <div class="panel" id="p2">
            <div class="panel-header"><span>PORTAL</span><button onclick="toggleFS('p2')" style="background:none;color:var(--neon-green);border:1px solid">MAX</button></div>
            <iframe id="vesselFrame"></iframe>
        </div>
    </div>

    <div class="controls">
        <div class="btn" onclick="seedProject()" style="color:var(--bully-magenta)">STRESS_TEST</div>
        <div class="btn" onclick="applyChanges()">HOT_RELOAD</div>
        <div class="btn" onclick="exportLinuxMirror()" style="color:orange">EXPORT_TXT</div>
        <div class="btn" onclick="document.getElementById('recInput').click()" style="color:#fff">RECOVERY</div>
    </div>
    <input type="file" id="recInput" style="display:none" onchange="importLinuxMirror(this)">

    <script>
        const DB_NAME = "NexusFS", STORE_NAME = "files";
        let currentFilePath = "";
        const log = (m, c="#0f0") => { const d = document.getElementById('term'); d.innerHTML += `<div>> <span style="color:${c}">${m}</span></div>`; d.scrollTop = d.scrollHeight; };
        const openDB = () => new Promise(res => { const r = indexedDB.open(DB_NAME, 1); r.onupgradeneeded = e => e.target.result.createObjectStore(STORE_NAME); r.onsuccess = e => res(e.target.result); });

        function toggleFS(id) { const p = document.getElementById(id); p.classList.toggle('fullscreen'); }

        async function mountAndIngest(input) {
            const files = input.files;
            const db = await openDB();
            let count = 0;
            for (const f of files) {
                if (f.name.match(/\.(html|css|js|py|txt)$/)) {
                    const content = await f.text();
                    await db.transaction(STORE_NAME, "readwrite").objectStore(STORE_NAME).put(content, f.name);
                    count++;
                    // AUTO-BOOT priority: index.html -> app.py -> althea.py
                    if (f.name.toLowerCase().includes('index.html') || f.name.toLowerCase().includes('althea')) {
                        loadFile(f.name, content);
                    }
                }
            }
            log(`INGESTED ${count} ASSETS. Portal Active.`, "#0f0");
        }

        function loadFile(name, content) {
            currentFilePath = name;
            document.getElementById('curFile').innerText = name;
            document.getElementById('codeEditor').value = content;
            applyChanges();
        }

        async function runCommand(v) {
            const [cmd, arg] = v.split(' ');
            const db = await openDB();
            if (cmd === 'ls') {
                const keys = await new Promise(res => db.transaction(STORE_NAME).objectStore(STORE_NAME).getAllKeys().onsuccess = e => res(e.target.result));
                log("FILES: " + (keys.join(', ') || 'EMPTY'), "white");
            } else if (cmd === 'open' && arg) {
                const req = db.transaction(STORE_NAME).objectStore(STORE_NAME).get(arg);
                req.onsuccess = () => req.result ? loadFile(arg, req.result) : log("NOT FOUND", "red");
            }
            document.getElementById('cliInput').value = '';
        }

        async function autoSave() {
            if (!currentFilePath) return;
            const db = await openDB();
            await db.transaction(STORE_NAME, "readwrite").objectStore(STORE_NAME).put(document.getElementById('codeEditor').value, currentFilePath);
        }

        function applyChanges() {
            const code = document.getElementById('codeEditor').value;
            const frame = document.getElementById('vesselFrame');
            const blob = new Blob([code], { type: 'text/html' });
            if(frame.src.startsWith('blob:')) URL.revokeObjectURL(frame.src);
            frame.src = URL.createObjectURL(blob);
            log("EMULATION REFRESHED.", "white");
        }

        async function exportLinuxMirror() {
            const db = await openDB();
            const store = db.transaction(STORE_NAME, "readonly").objectStore(STORE_NAME);
            const keys = await new Promise(res => store.getAllKeys().onsuccess = e => res(e.target.result));
            const vals = await new Promise(res => store.getAll().onsuccess = e => res(e.target.result));
            const data = { files: {} };
            keys.forEach((k, i) => data.files[k] = vals[i]);
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type:'text/plain'}));
            link.download = "NEXUS_IMAGE.txt";
            link.click();
        }

        async function importLinuxMirror(i) {
            log("DECODING IMAGE...", "var(--ui-cyan)");
            try {
                const text = await i.files[0].text();
                const data = JSON.parse(text), db = await openDB();
                const tx = db.transaction(STORE_NAME, "readwrite");
                await tx.objectStore(STORE_NAME).clear();
                for (const [p, c] of Object.entries(data.files)) await tx.objectStore(STORE_NAME).put(c, p);
                
                // BOOT TRIGGER
                const bootKey = Object.keys(data.files).find(k => k.toLowerCase().includes('html')) || Object.keys(data.files)[0];
                loadFile(bootKey, data.files[bootKey]);
                log("IMAGE BOOTED.", "#0f0");
            } catch (e) { log("IO ERROR", "red"); }
        }

        function seedProject() { loadFile('test.html', '<h1>NEXUS V26.6</h1><style>body{background:#000;color:#0f0;display:flex;justify-content:center;align-items:center;height:100vh;}</style>'); }
    </script>
</body>
</html>
